<?php
/**
 * @file
 * @TODO: Missing documentation!
 */

/**
 * Implements hook_proprocess_page().
 */
function grundsalg_maps_preprocess_page(&$variables) {
  // Add angular to certain node types.
  if (isset($variables['node'])) {
    $type = $variables['node']->bundle();
    if (in_array($type, array('subdivision', 'area', 'overview_page'))) {

      $variables['#attached']['library'][] = 'grundsalg_maps/openlayers';
      $variables['#attached']['library'][] = 'grundsalg_maps/angular';

      $config = \Drupal::getContainer()->get('itkore_admin.itkore_config');
      $path = '/' . drupal_get_path('module', 'grundsalg_maps');

      $cache_ttl = $config->get('grundsalg_maps_areas_cache');

      $variables['#attached']['drupalSettings']['grundsalg_maps'] = array(
        'dir' => $path  . '/js',
        'url' => $config->get('grundsalg_maps_url'),
        'cache_ttl' => isset($cache_ttl) ? $cache_ttl : 300,
        'map_type' => $type,
        'plot_type' => $variables['node']->get('field_plot_type')->target_id,
        'zoom' => array (
          'default' =>6,
          'min' => 1,
          'max' => 14,
        ),
        'popup' => array(
          'template' => $path . '/js/templates/popup.html',
          'marker' => $path . '/images/marker-icon.png',
          'icon' => $path . '/images/link-arrow.svg',
        ),
      );
    }
  }
}
